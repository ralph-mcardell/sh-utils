#!/bin/sh

echo "====================================================="
echo ">>>>>>>>>>>>>>>>>> DICT TESTS <<<<<<<<<<<<<<<<<<<<<<<"
echo "====================================================="

build_realpath() {
  local path="$1"
  echo $(realpath "${path}") || {
    echo "No realpath; falling back to setting EXEC_DIR with cd ${path} && pwd -P." >&2
    echo $(cd ${path} && pwd -P)
  }
}

EXEC_DIR=$(build_realpath $(dirname "$0"))
WORK_DIR=$(build_realpath "${EXEC_DIR}/..")

BUILD_DIR="${WORK_DIR}/build"
SHARED_DIR="${WORK_DIR}/shared"

. ${SHARED_DIR}/dict
. ${EXEC_DIR}/sh-test

empty_string_is_not_a_dict() {
  local notdict=''
  local is_dict="dict_is_dict  ${notdict}";
  REQUIRE_FALSE "${is_dict}"
}

arbitrary_string_is_not_a_dict() {
  local notdict='arbitrary_string'
  local is_dict="dict_is_dict  ${notdict}";
  REQUIRE_FALSE "${is_dict}"
}

declared_dict_variable_is_a_dict() {
  dict=$(dict_declare)
  local is_dict="dict_is_dict  "${dict}"";
  REQUIRE "${is_dict}"
}

non_dict_variables_are_not_tolerated() {
  ret=$(dict_set '' "${key}" "${expected}")
  CHECK $? -eq 1
  notdict="key${__DICT_FIELD_SEPARATOR__}value${__DICT_ENTRY_SEPARATOR__}"
  ret=$(dict_set "${notdict}" "key2" "something")
  CHECK $? -eq 1
  notdict="key${__DICT_FIELD_SEPARATOR__}value${__DICT_ENTRY_SEPARATOR__}"
  ret=$(dict_set_simple "${notdict}" "key2" "something-simple")
  CHECK $? -eq 1
  notdict="key${__DICT_FIELD_SEPARATOR__}value${__DICT_ENTRY_SEPARATOR__}"
  ret=$(dict_get "${notdict}" "key" )
  CHECK $? -eq 1
  notdict="key${__DICT_FIELD_SEPARATOR__}value${__DICT_ENTRY_SEPARATOR__}"
  ret=$(dict_get_simple "${notdict}" "key" )
  CHECK $? -eq 1
  notdict="key${__DICT_FIELD_SEPARATOR__}value${__DICT_ENTRY_SEPARATOR__}"
  ret=$(dict_remove "${notdict}" "key" )
  CHECK $? -eq 1
  notdict="key${__DICT_FIELD_SEPARATOR__}value${__DICT_ENTRY_SEPARATOR__}"
  $(dict_to_vars "${notdict}" "key" )
  CHECK $? -eq 1
}

cannot_retrieve_values_from_empty_dict() {
  local dict=$(dict_declare)
  CHECK "$(dict_get "${dict}" 'some_key')x" = "x"
  CHECK "$(dict_get_simple "${dict}" 'some_key')x" = "x"
  local dict2=$(dict_declare_simple)
  CHECK "$(dict_get "${dict2}" 'some_key')x" = "x"
  CHECK "$(dict_get_simple "${dict2}" 'some_key')x" = "x"
}

can_add_multiple_initial_values_on_dict_declaration() {
  dict=$(dict_declare )
  CHECK "$(dict_get "${dict}" 'some_key')x" = "x"
  local expected1='value 1'
  local expected2='value 2'
  local expected3='value 3'
  local key1='key1'
  local key2='key2'
  local key3='key3'
  dict=$(dict_declare "${key1}" "${expected1}" \
                      "${key2}" "${expected2}" "${key3}" "${expected3}")

  CHECK "$(dict_get "${dict}" "${key1}")A" = "${expected1}A"
  CHECK "$(dict_get "${dict}" "${key2}")B" = "${expected2}B"
  CHECK "$(dict_get "${dict}" "${key3}")C" = "${expected3}C"

  CHECK "$(dict_get "${dict}" 'some_key')x" = "x"
}

can_add_multiple_initial_simple_values_only_on_dict_declaration() {
  dict=$(dict_declare )
  CHECK "$(dict_get "${dict}" 'some_key')x" = "x"
  local expected1='value 1'
  local expected2='value 2'
  local expected3='value 3'
  local key1='key1'
  local key2='key2'
  local key3='key3'
  dict=$(dict_declare_simple "${key1}" "${expected1}" \
                             "${key2}" "${expected2}" "${key3}" "${expected3}")

  CHECK "$(dict_get "${dict}" "${key1}")A" = "${expected1}A"
  CHECK "$(dict_get "${dict}" "${key2}")B" = "${expected2}B"
  CHECK "$(dict_get "${dict}" "${key3}")C" = "${expected3}C"

  CHECK "$(dict_get "${dict}" 'some_key')x" = "x"
}

can_retrieve_just_the_value_for_key_for_dict_containing_single_entry() {
  local expected='value 1'
  local key='key1'

  local dict="$(dict_set $(dict_declare) "${key}" "${expected}")"

# Pass dict_get result directly inline with call to CHECK
  CHECK "$(dict_get "${dict}" "${key}")i" = "${expected}i"
  CHECK "$(dict_get_simple "${dict}" "${key}")i" = "${expected}i"

# Pass dict_get result via intermediate variable to call to CHECK
  local actual="$(dict_get "${dict}" "${key}")"
  CHECK "${actual}v" = "${expected}v"
  local actual="$(dict_get_simple "${dict}" "${key}")"
  CHECK "${actual}v" = "${expected}v"

  CHECK "$(dict_get "${dict}" 'some_key')x" = "x"
  CHECK "$(dict_get_simple "${dict}" 'some_key')x" = "x"
}

can_retrieve_just_the_values_for_keys_for_dict_containing_multiple_entries() {
  local expected1='value 1'
  local expected2='value 2'
  local expected3='value 3'
  local key1='key1'
  local key2='key2'
  local key3='key3'

# can add entries to dict when declared or by dict_set/dict_set_simple
  local dict="$(dict_declare "${key1}" "${expected1}")"
  dict="$(dict_set_simple "${dict}" "${key2}" "${expected2}")"
  dict="$(dict_set "${dict}" "${key3}" "${expected3}")"

  CHECK "$(dict_get "${dict}" "${key1}")A" = "${expected1}A"
  CHECK "$(dict_get "${dict}" "${key2}")B" = "${expected2}B"
  CHECK "$(dict_get "${dict}" "${key3}")C" = "${expected3}C"

  CHECK "$(dict_get_simple "${dict}" "${key1}")A" = "${expected1}A"
  CHECK "$(dict_get_simple "${dict}" "${key2}")B" = "${expected2}B"
  CHECK "$(dict_get_simple "${dict}" "${key3}")C" = "${expected3}C"

  CHECK "$(dict_get "${dict}" 'some_key')x" = "x"
  CHECK "$(dict_get_simple "${dict}" 'some_key')x" = "x"
}

can_update_values_of_previously_added_entries_using_dict_set() {
  local expected1='value 1'
  local expected2='value 2'
  local expected3='value 3'
  local key1='key1'
  local key2='key2'
  local key3='key3'
  local dict="$(dict_declare  \
    "${key1}" "PLACEHOLDER 1" \
    "${key2}" "PLACEHOLDER 2" \
    "${key3}" "PLACEHOLDER 3")"

  dict="$(dict_set "${dict}" "${key1}" "${expected1}")"
  dict="$(dict_set "${dict}" "${key2}" "${expected2}")"
  dict="$(dict_set "${dict}" "${key3}" "${expected3}")"

  CHECK "$(dict_get "${dict}" "${key1}")A" = "${expected1}A"
  CHECK "$(dict_get "${dict}" "${key2}")B" = "${expected2}B"
  CHECK "$(dict_get "${dict}" "${key3}")C" = "${expected3}C"

  CHECK "$(dict_get "${dict}" 'some_key')x" = "x"
}

can_update_values_of_previously_added_entries_using_dict_set_simple() {
  local expected1='value 1'
  local expected2='value 2'
  local expected3='value 3'
  local key1='key1'
  local key2='key2'
  local key3='key3'
  local dict="$(dict_declare_simple  \
    "${key1}" "PLACEHOLDER 1" \
    "${key2}" "PLACEHOLDER 2" \
    "${key3}" "PLACEHOLDER 3")"

  dict="$(dict_set_simple "${dict}" "${key1}" "${expected1}")"
  dict="$(dict_set_simple "${dict}" "${key2}" "${expected2}")"
  dict="$(dict_set_simple "${dict}" "${key3}" "${expected3}")"

  CHECK "$(dict_get_simple "${dict}" "${key1}")A" = "${expected1}A"
  CHECK "$(dict_get_simple "${dict}" "${key2}")B" = "${expected2}B"
  CHECK "$(dict_get_simple "${dict}" "${key3}")C" = "${expected3}C"

  CHECK "$(dict_get_simple "${dict}" 'some_key')x" = "x"
}

can_add_retrieve_values_with_keys_tails_of_other_keys() {
  local expected1='value 1'
  local expected2='value 2'
  local expected3='value 3'
  local key1='firstkey'
  local key2='key'
  local key3='lastkey'
  local dict="$(dict_declare  \
    "${key1}" "${expected1}" \
    "${key2}" "${expected2}" \
    "${key3}" "${expected3}")"

  CHECK "$(dict_get "${dict}" "${key1}")A" = "${expected1}A"
  CHECK "$(dict_get "${dict}" "${key2}")B" = "${expected2}B"
  CHECK "$(dict_get "${dict}" "${key3}")C" = "${expected3}C"

  CHECK "$(dict_get_simple "${dict}" "${key1}")A" = "${expected1}A"
  CHECK "$(dict_get_simple "${dict}" "${key2}")B" = "${expected2}B"
  CHECK "$(dict_get_simple "${dict}" "${key3}")C" = "${expected3}C"
}

can_add_retrieve_values_with_keys_heads_of_other_keys() {
  local expected1='value 1'
  local expected2='value 2'
  local expected3='value 3'
  local key1='key1'
  local key2='key'
  local key3='key3'
  local dict=$(dict_declare)
  dict="$(dict_set "${dict}" "${key1}" "${expected1}")"
  dict="$(dict_set "${dict}" "${key2}" "${expected2}")"
  dict="$(dict_set "${dict}" "${key3}" "${expected3}")"

  CHECK "$(dict_get "${dict}" "${key1}")A" = "${expected1}A"
  CHECK "$(dict_get "${dict}" "${key2}")B" = "${expected2}B"
  CHECK "$(dict_get "${dict}" "${key3}")C" = "${expected3}C"

  CHECK "$(dict_get_simple "${dict}" "${key1}")A" = "${expected1}A"
  CHECK "$(dict_get_simple "${dict}" "${key2}")B" = "${expected2}B"
  CHECK "$(dict_get_simple "${dict}" "${key3}")C" = "${expected3}C"
}

can_add_retrieve_values_with_keys_contained_in_other_keys() {
  local expected1='value 1'
  local expected2='value 2'
  local expected3='value 3'
  local key1='1key1'
  local key2='key'
  local key3='3key3'
  local dict=$(dict_declare)
  dict="$(dict_set_simple "${dict}" "${key1}" "${expected1}")"
  dict="$(dict_set_simple "${dict}" "${key2}" "${expected2}")"
  dict="$(dict_set_simple "${dict}" "${key3}" "${expected3}")"

  CHECK "$(dict_get "${dict}" "${key1}")A" = "${expected1}A"
  CHECK "$(dict_get "${dict}" "${key2}")B" = "${expected2}B"
  CHECK "$(dict_get "${dict}" "${key3}")C" = "${expected3}C"

  CHECK "$(dict_get_simple "${dict}" "${key1}")A" = "${expected1}A"
  CHECK "$(dict_get_simple "${dict}" "${key2}")B" = "${expected2}B"
  CHECK "$(dict_get_simple "${dict}" "${key3}")C" = "${expected3}C"
}

can_add_and_retrieve_entries_correctly_with_key_values_within_values() {
  local keyvalue='key_value'
  local beforeprefixkey="beforeprefix"
  local beforesuffixkey="beforesuffix"
  local aftersuffixkey="aftersuffix"
  local afterprefixkey="afterprefix"
  local dict=$(dict_declare)

  dict="$(dict_set "${dict}" "${beforeprefixkey}" "${beforeprefixkey}${keyvalue}")"
  dict="$(dict_set "${dict}" "${beforesuffixkey}" "${keyvalue}${beforesuffixkey}")"
  dict="$(dict_set "${dict}" "${keyvalue}" "${keyvalue}")"
  dict="$(dict_set "${dict}" "${aftersuffixkey}" "${keyvalue}${aftersuffixkey}")"
  dict="$(dict_set "${dict}" "${afterprefixkey}" "${afterprefixkey}${keyvalue}")"
  CHECK "$(dict_get "${dict}" "${keyvalue}")B" = "${keyvalue}B"
  CHECK "$(dict_get "${dict}" "${beforeprefixkey}")B" = "${beforeprefixkey}${keyvalue}B"
  CHECK "$(dict_get "${dict}" "${beforesuffixkey}")B" = "${keyvalue}${beforesuffixkey}B"
  CHECK "$(dict_get "${dict}" "${aftersuffixkey}")B" = "${keyvalue}${aftersuffixkey}B"
  CHECK "$(dict_get "${dict}" "${afterprefixkey}")B" = "${afterprefixkey}${keyvalue}B"
}

can_add_update_and_retrieve_entries_correctly_with_key_values_within_values() {
  local keyvalue='key_value'
  local beforeprefixkey="beforeprefix"
  local beforesuffixkey="beforesuffix"
  local aftersuffixkey="aftersuffix"
  local afterprefixkey="afterprefix"
  local dict=$(dict_declare)

  dict="$(dict_set "${dict}" "${beforeprefixkey}" "${beforeprefixkey}PLACEHOLDER")"
  dict="$(dict_set "${dict}" "${beforesuffixkey}" "PLACEHOLDER${beforesuffixkey}")"
  dict="$(dict_set "${dict}" "${keyvalue}" "${keyvalue}")"
  dict="$(dict_set "${dict}" "${aftersuffixkey}" "PLACEHOLDER${aftersuffixkey}")"
  dict="$(dict_set "${dict}" "${afterprefixkey}" "${afterprefixkey}PLACEHOLDER")"

  dict="$(dict_set "${dict}" "${beforeprefixkey}" "${beforeprefixkey}${keyvalue}")"
  dict="$(dict_set "${dict}" "${beforesuffixkey}" "${keyvalue}${beforesuffixkey}")"
  dict="$(dict_set "${dict}" "${aftersuffixkey}" "${keyvalue}${aftersuffixkey}")"
  dict="$(dict_set "${dict}" "${afterprefixkey}" "${afterprefixkey}${keyvalue}")"

  CHECK "$(dict_get "${dict}" "${keyvalue}")B" = "${keyvalue}B"

  CHECK "$(dict_get "${dict}" "${beforeprefixkey}")B" = "${beforeprefixkey}${keyvalue}B"
  CHECK "$(dict_get "${dict}" "${beforesuffixkey}")B" = "${keyvalue}${beforesuffixkey}B"
  CHECK "$(dict_get "${dict}" "${aftersuffixkey}")B" = "${keyvalue}${aftersuffixkey}B"
  CHECK "$(dict_get "${dict}" "${afterprefixkey}")B" = "${afterprefixkey}${keyvalue}B"
}

can_remove_whole_entry_specified_by_key_from_dict() {
  local expected1='value 1'
  local expected2='value 2'
  local expected3='value 3'
  local key1='key1'
  local key2='key2'
  local key3='key3'
  local dict=$(dict_declare)
  dict="$(dict_set "${dict}" "${key1}" "${expected1}")"
  dict="$(dict_set "${dict}" "${key2}" "${expected2}")"
  dict="$(dict_set "${dict}" "${key3}" "${expected3}")"

  REQUIRE "$(dict_get "${dict}" "${key1}")A" = "${expected1}A"
  REQUIRE "$(dict_get "${dict}" "${key2}")B" = "${expected2}B"
  REQUIRE "$(dict_get "${dict}" "${key3}")C" = "${expected3}C"

  dict="$(dict_remove "${dict}" "${key2}")"
  CHECK "$(dict_get "${dict}" "${key1}")A" = "${expected1}A"
  CHECK "$(dict_get "${dict}" "${key2}")B" = "B"
  CHECK "$(dict_get "${dict}" "${key3}")C" = "${expected3}C"

  dict="$(dict_remove "${dict}" "${key3}")"
  CHECK "$(dict_get "${dict}" "${key1}")A" = "${expected1}A"
  CHECK "$(dict_get "${dict}" "${key2}")B" = "B"
  CHECK "$(dict_get "${dict}" "${key3}")C" = "C"

  dict="$(dict_remove "${dict}" "${key1}")"
  CHECK "$(dict_get "${dict}" "${key1}")A" = "A"
  CHECK "$(dict_get "${dict}" "${key2}")B" = "B"
  CHECK "$(dict_get "${dict}" "${key3}")C" = "C"
}

added_nested_dict_values_can_be_retrieved_correctly() {
  local expected1='value 1'
  local expected2='value 2'
  local expected3='value 3'
  local key1='key1'
  local key2='key2'
  local key3='key3'

  local dict_2_1=$(dict_declare)
  dict_2_1="$(dict_set "${dict_2_1}" "${key1}2_1" "${expected1}2_1")"
  dict_2_1="$(dict_set "${dict_2_1}" "${key2}2_1" "${expected2}2_1")"
  dict_2_1="$(dict_set "${dict_2_1}" "${key3}2_1" "${expected3}2_1")"
  local dict_2_2=$(dict_declare)
  dict_2_2="$(dict_set "${dict_2_2}" "${key1}2_2" "${expected1}2_2")"
  dict_2_2="$(dict_set "${dict_2_2}" "${key2}2_2" "${expected2}2_2")"
  dict_2_2="$(dict_set "${dict_2_2}" "${key3}2_2" "${expected3}2_2")"
  local dict_2_3=$(dict_declare)
  dict_2_3="$(dict_set "${dict_2_3}" "${key1}2_3" "${expected1}2_3")"
  dict_2_3="$(dict_set "${dict_2_3}" "${key2}2_3" "${expected2}2_3")"
  dict_2_3="$(dict_set "${dict_2_3}" "${key3}2_3" "${expected3}2_3")"

  local dict_1_1=$(dict_declare)
  dict_1_1="$(dict_set "${dict_1_1}" "${key1}1_1" "${expected1}1_1")"
  dict_1_1="$(dict_set "${dict_1_1}" "${key2}1_1" "${expected2}1_1")"
  dict_1_1="$(dict_set "${dict_1_1}" "${key3}1_1" "${expected3}1_1")"
  local dict_1_2=$(dict_declare)
  dict_1_2="$(dict_set "${dict_1_2}" "${key1}1_2" "${expected1}1_2")"
  dict_1_2="$(dict_set "${dict_1_2}" "${key2}1_2" "${expected2}1_2")"
  dict_1_2="$(dict_set "${dict_1_2}" "${key3}1_2" "${expected3}1_2")"
  local dict_1_3=$(dict_declare)
  dict_1_3="$(dict_set "${dict_1_3}" "${key1}1_3" "${dict_2_1}")"
  dict_1_3="$(dict_set "${dict_1_3}" "${key2}1_3" "${dict_2_2}")"
  dict_1_3="$(dict_set "${dict_1_3}" "${key3}1_3" "${dict_2_3}")"

  local dict=$(dict_declare)
  dict="$(dict_set "${dict}" "${key1}" "${dict_1_1}")"
  dict="$(dict_set "${dict}" "${key2}" "${dict_1_2}")"
  dict="$(dict_set "${dict}" "${key3}" "${dict_1_3}")"

  v="$(dict_get "${dict}" "${key1}")"
  REQUIRE -n "${v}"
  CHECK "$(dict_get "${v}" "${key1}1_1")A" = "${expected1}1_1A"
  CHECK "$(dict_get "${v}" "${key2}1_1")A" = "${expected2}1_1A"
  CHECK "$(dict_get "${v}" "${key3}1_1")A" = "${expected3}1_1A"

  v="$(dict_get "${dict}" "${key2}")"
  REQUIRE -n "${v}"
  CHECK "$(dict_get "${v}" "${key1}1_2")A" = "${expected1}1_2A"
  CHECK "$(dict_get "${v}" "${key2}1_2")A" = "${expected2}1_2A"
  CHECK "$(dict_get "${v}" "${key3}1_2")A" = "${expected3}1_2A"

  v="$(dict_get "${dict}" "${key3}")"
  REQUIRE -n "${v}"

  vv="$(dict_get "${v}" "${key1}1_3")"
  REQUIRE -n "${vv}"
  CHECK "$(dict_get "${vv}" "${key1}2_1")A" = "${expected1}2_1A"
  CHECK "$(dict_get "${vv}" "${key2}2_1")A" = "${expected2}2_1A"
  CHECK "$(dict_get "${vv}" "${key3}2_1")A" = "${expected3}2_1A"

  vv="$(dict_get "${v}" "${key2}1_3")"
  REQUIRE -n "${vv}"
  CHECK "$(dict_get "${vv}" "${key1}2_2")A" = "${expected1}2_2A"
  CHECK "$(dict_get "${vv}" "${key2}2_2")A" = "${expected2}2_2A"
  CHECK "$(dict_get "${vv}" "${key3}2_2")A" = "${expected3}2_2A"

  vv="$(dict_get "${v}" "${key3}1_3")"
  REQUIRE -n "${vv}"
  CHECK "$(dict_get "${vv}" "${key1}2_3")A" = "${expected1}2_3A"
  CHECK "$(dict_get "${vv}" "${key2}2_3")A" = "${expected2}2_3A"
  CHECK "$(dict_get "${vv}" "${key3}2_3")A" = "${expected3}2_3A"
}

initialised_nested_dict_values_can_be_retrieved_correctly() {
  local expected1='value 1'
  local expected2='value 2'
  local expected3='value 3'
  local key1='key1'
  local key2='key2'
  local key3='key3'

  local dict_2_1="$(dict_declare \
    "${key1}2_1" "${expected1}2_1" \
    "${key2}2_1" "${expected2}2_1" \
    "${key3}2_1" "${expected3}2_1")"
  local dict_2_2="$(dict_declare_simple \
    "${key1}2_2" "${expected1}2_2" \
    "${key2}2_2" "${expected2}2_2" \
    "${key3}2_2" "${expected3}2_2")"
  local dict_2_3="$(dict_declare_simple \
    "${key1}2_3" "${expected1}2_3" \
    "${key2}2_3" "${expected2}2_3" \
    "${key3}2_3" "${expected3}2_3")"

  local dict_1_1="$(dict_declare \
    "${key1}1_1" "${expected1}1_1" \
    "${key2}1_1" "${expected2}1_1" \
    "${key3}1_1" "${expected3}1_1")"
  local dict_1_2="$(dict_declare_simple \
    "${key1}1_2" "${expected1}1_2" \
    "${key2}1_2" "${expected2}1_2" \
    "${key3}1_2" "${expected3}1_2")"
  local dict_1_3="$(dict_declare \
    "${key1}1_3" "${dict_2_1}" \
    "${key2}1_3" "${dict_2_2}" \
    "${key3}1_3" "${dict_2_3}")"

  local dict="$(dict_declare \
    "${key1}" "${dict_1_1}" \
    "${key2}" "${dict_1_2}" \
    "${key3}" "${dict_1_3}")"

  v="$(dict_get "${dict}" "${key1}")"
  REQUIRE -n "${v}"
  CHECK "$(dict_get "${v}" "${key1}1_1")A" = "${expected1}1_1A"
  CHECK "$(dict_get "${v}" "${key2}1_1")A" = "${expected2}1_1A"
  CHECK "$(dict_get "${v}" "${key3}1_1")A" = "${expected3}1_1A"

  v="$(dict_get "${dict}" "${key2}")"
  REQUIRE -n "${v}"
  CHECK "$(dict_get "${v}" "${key1}1_2")A" = "${expected1}1_2A"
  CHECK "$(dict_get "${v}" "${key2}1_2")A" = "${expected2}1_2A"
  CHECK "$(dict_get "${v}" "${key3}1_2")A" = "${expected3}1_2A"

  v="$(dict_get "${dict}" "${key3}")"
  REQUIRE -n "${v}"

  vv="$(dict_get "${v}" "${key1}1_3")"
  REQUIRE -n "${vv}"
  CHECK "$(dict_get "${vv}" "${key1}2_1")A" = "${expected1}2_1A"
  CHECK "$(dict_get "${vv}" "${key2}2_1")A" = "${expected2}2_1A"
  CHECK "$(dict_get "${vv}" "${key3}2_1")A" = "${expected3}2_1A"

  vv="$(dict_get "${v}" "${key2}1_3")"
  REQUIRE -n "${vv}"
  CHECK "$(dict_get "${vv}" "${key1}2_2")A" = "${expected1}2_2A"
  CHECK "$(dict_get "${vv}" "${key2}2_2")A" = "${expected2}2_2A"
  CHECK "$(dict_get "${vv}" "${key3}2_2")A" = "${expected3}2_2A"

  vv="$(dict_get "${v}" "${key3}1_3")"
  REQUIRE -n "${vv}"
  CHECK "$(dict_get "${vv}" "${key1}2_3")A" = "${expected1}2_3A"
  CHECK "$(dict_get "${vv}" "${key2}2_3")A" = "${expected2}2_3A"
  CHECK "$(dict_get "${vv}" "${key3}2_3")A" = "${expected3}2_3A"
}

nested_dict_values_can_be_removed_correctly() {
  local expected1='value 1'
  local expected2='value 2'
  local expected3='value 3'
  local key1='key1'
  local key2='key2'
  local key3='key3'

  local dict_2_1="$(dict_declare \
    "${key1}2_1" "${expected1}2_1" \
    "${key2}2_1" "${expected2}2_1" \
    "${key3}2_1" "${expected3}2_1")"
  local dict_2_2="$(dict_declare_simple \
    "${key1}2_2" "${expected1}2_2" \
    "${key2}2_2" "${expected2}2_2" \
    "${key3}2_2" "${expected3}2_2")"
  local dict_2_3=$(dict_declare)
  dict_2_3="$(dict_set "${dict_2_3}" "${key1}2_3" "${expected1}2_3")"
  dict_2_3="$(dict_set "${dict_2_3}" "${key2}2_3" "${expected2}2_3")"
  dict_2_3="$(dict_set "${dict_2_3}" "${key3}2_3" "${expected3}2_3")"

  local dict_1_1=$(dict_declare)
  dict_1_1="$(dict_set_simple "${dict_1_1}" "${key1}1_1" "${expected1}1_1")"
  dict_1_1="$(dict_set_simple "${dict_1_1}" "${key2}1_1" "${expected2}1_1")"
  dict_1_1="$(dict_set_simple "${dict_1_1}" "${key3}1_1" "${expected3}1_1")"
  local dict_1_2=$(dict_declare_simple)
  dict_1_2="$(dict_set_simple "${dict_1_2}" "${key1}1_2" "${expected1}1_2")"
  dict_1_2="$(dict_set_simple "${dict_1_2}" "${key2}1_2" "${expected2}1_2")"
  dict_1_2="$(dict_set_simple "${dict_1_2}" "${key3}1_2" "${expected3}1_2")"
  local dict_1_3=$(dict_declare_simple)
  dict_1_3="$(dict_set "${dict_1_3}" "${key1}1_3" "${dict_2_1}")"
  dict_1_3="$(dict_set "${dict_1_3}" "${key2}1_3" "${dict_2_2}")"
  dict_1_3="$(dict_set "${dict_1_3}" "${key3}1_3" "${dict_2_3}")"

  local dict=$(dict_declare)
  dict="$(dict_set "${dict}" "${key1}" "${dict_1_1}")"
  dict="$(dict_set "${dict}" "${key2}" "${dict_1_2}")"
  dict="$(dict_set "${dict}" "${key3}" "${dict_1_3}")"

  REQUIRE "$(dict_get "${dict}" "${key1}")A" = "${dict_1_1}A"
  REQUIRE "$(dict_get "${dict}" "${key2}")B" = "${dict_1_2}B"
  REQUIRE "$(dict_get "${dict}" "${key3}")C" = "${dict_1_3}C"

  dict="$(dict_remove "${dict}" "${key2}")"
  CHECK "$(dict_get "${dict}" "${key1}")A" = "${dict_1_1}A"
  CHECK "$(dict_get "${dict}" "${key2}")B" = "B"
  CHECK "$(dict_get "${dict}" "${key3}")C" = "${dict_1_3}C"

  dict="$(dict_remove "${dict}" "${key3}")"
  CHECK "$(dict_get "${dict}" "${key1}")A" = "${dict_1_1}A"
  CHECK "$(dict_get "${dict}" "${key2}")B" = "B"
  CHECK "$(dict_get "${dict}" "${key3}")C" = "C"

  dict="$(dict_remove "${dict}" "${key1}")"
  CHECK "$(dict_get "${dict}" "${key1}")A" = "A"
  CHECK "$(dict_get "${dict}" "${key2}")B" = "B"
  CHECK "$(dict_get "${dict}" "${key3}")C" = "C"
}

can_create_variable_of_key_name_with_associated_value_for_each_dict_entry() {
  local expected1='value 1'
  local expected2='value 2'
  local expected3='value 3'
  local key1='__key1__'
  local key2='__key2__'
  local key3='__key3__'
  local dict=$(dict_declare)
  dict="$(dict_set "${dict}" "${key1}" "${expected1}")"
  dict="$(dict_set "${dict}" "${key2}" "${expected2}")"
  dict="$(dict_set "${dict}" "${key3}" "${expected3}")"

  REQUIRE "$(dict_get "${dict}" "${key1}")A" = "${expected1}A"
  REQUIRE "$(dict_get "${dict}" "${key2}")B" = "${expected2}B"
  REQUIRE "$(dict_get "${dict}" "${key3}")C" = "${expected3}C"
  # Check we do not have variables defined already
  REQUIRE -z "${__key1__:+x}"
  REQUIRE -z "${__key2__:+x}"
  REQUIRE -z "${__key3__:+x}"

  dict_to_vars "${dict}"

  REQUIRE -n "${__key1__:+x}"
  REQUIRE -n "${__key2__:+x}"
  REQUIRE -n "${__key3__:+x}"
  CHECK "${__key1__}A" = "${expected1}A"
  CHECK "${__key2__}B" = "${expected2}B"
  CHECK "${__key3__}C" = "${expected3}C"
  unset __key1__
  unset __key2__
  unset __key3__
}


test_dict_for_each_fn_called_count=0
test_dict_for_each_fn_actual=''
test_dict_for_each_fn_additional_parameters=''
test_dict_for_each_collect_call_data() {
  local key="${1}"
  local value="${2}"
  shift 2
  test_dict_for_each_fn_actual="${key}${test_dict_for_each_fn_actual}${value}"
  test_dict_for_each_fn_called_count=$((${test_dict_for_each_fn_called_count}+1))
  test_dict_for_each_fn_additional_parameters="${test_dict_for_each_fn_additional_parameters} $@"
}

iterating_over_empty_dict_does_not_call_operation_function() {
  test_dict_for_each_fn_called_count=0
  test_dict_for_each_fn_actual=''

  dict_for_each $(dict_declare_simple) test_dict_for_each_collect_call_data
  CHECK "${test_dict_for_each_fn_called_count}" -eq 0
  CHECK -z "${test_dict_for_each_fn_actual}"
}

iterating_over_single_entry_dict_calls_operation_function_once_with_key_and_value() {
  local value='value 1'
  local key='key1'
  local expected="${key}${value}"

  test_dict_for_each_fn_called_count=0
  test_dict_for_each_fn_actual=''
  dict_for_each "$(dict_declare_simple "${key}" "${value}")" test_dict_for_each_collect_call_data
  CHECK "${test_dict_for_each_fn_called_count}" -eq 1
  CHECK "${test_dict_for_each_fn_actual}" = "${expected}"
}

iterating_over_n_entry_dict_calls_operation_function_n_times_with_each_key_and_value() {
  local value1='value 1'
  local value1='value 2'
  local value1='value 3'
  local key1='key1'
  local key2='key2'
  local key3='key3'
  local entry_count=3
  dict=$(dict_declare_simple "${key1}" "${value1}" \
                             "${key2}" "${value2}" "${key3}" "${value3}")
  local expected="${key3}${key2}${key1}${value1}${value2}${value3}"

  test_dict_for_each_fn_called_count=0
  test_dict_for_each_fn_actual=''
  dict_for_each "${dict}" test_dict_for_each_collect_call_data
  CHECK "${test_dict_for_each_fn_called_count}" -eq "${entry_count}"
  CHECK "${test_dict_for_each_fn_actual}" = "${expected}"
}

iterating_over_dict_calls_operation_function_passing_additional_parameters() {
  p1="one"
  p2="two"
  local expected=" ${p1} ${p2} ${p1} ${p2} ${p1} ${p2}"
  test_dict_for_each_fn_additional_parameters=''
  dict_for_each "$(dict_declare_simple "a" "1" "b" "2" "c" "3")" test_dict_for_each_collect_call_data "${p1}" "${p2}"
  CHECK "${test_dict_for_each_fn_additional_parameters}" = "${expected}"
}

iterating_over_dict_with_nested_dict_values_passes_correct_key_values() {
  local keyi11="keyi1"
  local keyi12="keyi2"
  local valuei11="value i 1 1"
  local valuei12="value i _ 2"
  local inner1="$(dict_declare_simple "${keyi11}" "${valuei11}" "${keyi12}" "${valuei12}")"
  local keyi21="keyi1"
  local keyi22="keyi2"
  local valuei21="value i 1 1"
  local valuei22="value i _ 2"
  local inner2="$(dict_declare_simple "${keyi12}" "${valuei21}" "${keyi22}" "${valuei22}")"

  local keym11="keym1"
  local keym12="keym2"
  local keym13="keym3"
  local valuem11="value m 1 1"
  local valuem13="value m _ _"
  local mid1="$(dict_declare "${keym11}" "${valuem11}" "${keym12}" "${inner1}" "${keym13}" "${valuem13}")"
  local keym21="keym1"
  local keym22="keym2"
  local keym23="keym3"
  local keym24="keym4"
  local valuem22="value m _ _"
  local valuem23="value m 2 3"
  local mid2="$(dict_declare "${keym21}" "${inner1}" "${keym22}" "${valuem22}" "${keym23}" "${valuem23}" "${keym24}"  "${inner2}")"

  local keyo1="keyo1"
  local keyo2="keyo2"
  local keyo3="keyo3"
  local keyo4="keyo4"
  local valueo1="value o one"
  local valueo4="value o four"
  local outer="$(dict_declare "${keyo1}"  "${valueo1}"  "${keyo2}" "${mid1}" "${keyo3}" "${mid2}" "${keyo4}"  "${valueo4}")"

  test_dict_for_each_fn_called_count=0
  test_dict_for_each_fn_actual=''
  local entry_count=4
  local expected="${keyo4}${keyo3}${keyo2}${keyo1}${valueo1}${mid1}${mid2}${valueo4}"

  dict_for_each "${outer}" test_dict_for_each_collect_call_data
  CHECK "${test_dict_for_each_fn_called_count}" -eq "${entry_count}"
  CHECK "${test_dict_for_each_fn_actual}" = "${expected}" | tr "${__DICT_GS__}${__DICT_RS__}${__DICT_US__}" '^_'
}

#set -x
TEST empty_string_is_not_a_dict
TEST arbitrary_string_is_not_a_dict
TEST declared_dict_variable_is_a_dict
TEST non_dict_variables_are_not_tolerated
TEST cannot_retrieve_values_from_empty_dict
TEST can_add_multiple_initial_values_on_dict_declaration
TEST can_add_multiple_initial_simple_values_only_on_dict_declaration
TEST can_retrieve_just_the_value_for_key_for_dict_containing_single_entry
TEST can_retrieve_just_the_values_for_keys_for_dict_containing_multiple_entries
TEST can_update_values_of_previously_added_entries_using_dict_set
TEST can_update_values_of_previously_added_entries_using_dict_set_simple
TEST can_add_retrieve_values_with_keys_tails_of_other_keys
TEST can_add_retrieve_values_with_keys_heads_of_other_keys
TEST can_add_retrieve_values_with_keys_contained_in_other_keys
TEST can_add_and_retrieve_entries_correctly_with_key_values_within_values
TEST can_add_update_and_retrieve_entries_correctly_with_key_values_within_values
TEST can_remove_whole_entry_specified_by_key_from_dict
TEST iterating_over_empty_dict_does_not_call_operation_function
TEST iterating_over_single_entry_dict_calls_operation_function_once_with_key_and_value
TEST iterating_over_n_entry_dict_calls_operation_function_n_times_with_each_key_and_value
TEST iterating_over_dict_calls_operation_function_passing_additional_parameters
TEST added_nested_dict_values_can_be_retrieved_correctly
TEST initialised_nested_dict_values_can_be_retrieved_correctly
TEST nested_dict_values_can_be_removed_correctly
TEST iterating_over_dict_with_nested_dict_values_passes_correct_key_values
TEST can_create_variable_of_key_name_with_associated_value_for_each_dict_entry
PRINT_TEST_COUNTS

exit 0
